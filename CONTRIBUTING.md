# è´¡çŒ®æŒ‡å—

æ¬¢è¿ä¸º infra é¡¹ç›®è´¡çŒ®ä»£ç ï¼æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•å‚ä¸å¼€å‘ã€‚

## ğŸ”§ å¼€å‘ç¯å¢ƒ

### 1. GitHub Actions (è‡ªåŠ¨åŒ–)

- **é…ç½®æ–‡ä»¶ä½ç½®**: `.github/workflows/`
- **è§¦å‘æ¡ä»¶**: push åˆ° main/develop åˆ†æ”¯ï¼ŒPR
- **åŠŸèƒ½ç‰¹æ€§**:
  - å¤šç‰ˆæœ¬ Go æµ‹è¯• (1.23, 1.24, 1.25)
  - ä»£ç è´¨é‡æ£€æŸ¥ (golangci-lint)
  - å®‰å…¨æ‰«æ (gosec)
  - è·¨å¹³å°æ„å»ºéªŒè¯ (Linux, Windows, macOS)
  - è¦†ç›–ç‡æŠ¥å‘Šä¸Šä¼  (Codecov)

### 2. æœ¬åœ° Act å¼€å‘

- **é…ç½®æ–‡ä»¶**: `.actrc`
- **æ¨¡æ‹Ÿäº‹ä»¶**: `.github/event.json`
- **Secrets ç®¡ç†**: `.secrets`
- **ç”¨é€”**: æœ¬åœ°å¼€å‘å’Œè°ƒè¯• CI/CD æµç¨‹

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æœ¬åœ°å¼€å‘

```bash
# å…‹éš†ä»“åº“
git clone <repository-url>
cd infra

# å®‰è£…ä¾èµ–
go mod download

# è¿è¡Œæµ‹è¯•
go test ./...

# ä»£ç æ ¼å¼åŒ–
go fmt ./...
```

### æœ¬åœ° CI/CD æµ‹è¯•

#### å®‰è£… act

```bash
# macOS
brew install act

# æˆ–ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
curl -Lo act.tar.gz https://github.com/nektos/act/releases/latest/download/act_Linux_x86_64.tar.gz
tar -xzf act.tar.gz && sudo mv act /usr/local/bin/
```

#### é…ç½® actï¼ˆå·²é¢„é…ç½®ï¼‰

é¡¹ç›®å·²é…ç½®å¥½ä»¥ä¸‹æ–‡ä»¶ï¼š

- **`.actrc`** - act è¿è¡Œé…ç½®ï¼Œä½¿ç”¨è…¾è®¯äº‘é•œåƒæº
- **`.secrets`** - æ•æ„Ÿä¿¡æ¯é…ç½®æ–‡ä»¶
- **`.github/event.json`** - æ¨¡æ‹Ÿ GitHub äº‹ä»¶æ•°æ®

#### è¿è¡Œå·¥ä½œæµ

```bash
# è¿è¡Œæ‰€æœ‰å·¥ä½œæµ
act

# è¿è¡Œç‰¹å®š job
act -j test
act -j security
act -j build

# æŸ¥çœ‹å¯ç”¨çš„å·¥ä½œæµ
act -l

# ä½¿ç”¨è¯¦ç»†æ—¥å¿—
act --verbose
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
.
â”œâ”€â”€ .github/
â”‚   â”œâ”€â”€ workflows/
â”‚   â”‚   â””â”€â”€ ci.yml          # æŒç»­é›†æˆ
â”‚   â””â”€â”€ event.json          # æœ¬åœ°æµ‹è¯•äº‹ä»¶
â”œâ”€â”€ .actrc                  # act é…ç½®æ–‡ä»¶
â”œâ”€â”€ .secrets               # æ•æ„Ÿä¿¡æ¯æ–‡ä»¶ï¼ˆå·²æ·»åŠ åˆ° .gitignoreï¼‰
â”œâ”€â”€ backoff/                # é‡è¯•åº“
â”œâ”€â”€ co/                     # å¹¶å‘å·¥å…·åŒ…
â”œâ”€â”€ sdm/                    # åˆ†å¸ƒå¼äº’æ–¥é”
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ README.md
â”œâ”€â”€ README.zh-CN.md
â””â”€â”€ CONTRIBUTING.md         # æœ¬æ–‡æ¡£
```

## âš™ï¸ Act é…ç½®è¯¦è§£

### å½“å‰é…ç½®è¯´æ˜

- **é•œåƒæº**: ä½¿ç”¨è…¾è®¯äº‘é•œåƒæº `ccr.ccs.tencentyun.com/library/ubuntu:22.04`
- **M1 èŠ¯ç‰‡æ”¯æŒ**: é…ç½®äº† `linux/amd64` æ¶æ„
- **ç¦»çº¿æ¨¡å¼**: ä½¿ç”¨ `--bind` æ¨¡å¼å‡å°‘ç½‘ç»œä¾èµ–
- **è‡ªåŠ¨æ¸…ç†**: è¿è¡Œåè‡ªåŠ¨æ¸…ç†å®¹å™¨

### è‡ªå®šä¹‰é…ç½®

ç¼–è¾‘ `.actrc` æ–‡ä»¶å¯ä»¥ä¿®æ”¹ï¼š

- é•œåƒæºåœ°å€
- å®¹å™¨æ¶æ„
- å·¥ä½œæµè·¯å¾„
- å…¶ä»–è¿è¡Œå‚æ•°

### Secrets ç®¡ç†

`.secrets` æ–‡ä»¶åŒ…å«ï¼š

```bash
# é»˜è®¤ä½¿ç”¨ fake token é¿å…è®¤è¯é—®é¢˜
GITHUB_TOKEN=fake-token-for-local-testing

# å¦‚éœ€çœŸå® tokenï¼Œå–æ¶ˆæ³¨é‡Šå¹¶å¡«å…¥
# GITHUB_TOKEN=ghp_your_real_github_token_here
```

## ğŸ“ æäº¤è§„èŒƒ

### æäº¤ä¿¡æ¯æ ¼å¼

```
<ç±»å‹>: <æè¿°>

[å¯é€‰çš„è¯¦ç»†è¯´æ˜]

[å¯é€‰çš„å…³é—­é—®é¢˜]
```

### ç±»å‹

- `åŠŸèƒ½`: æ–°åŠŸèƒ½
- `ä¿®å¤`: ä¿®å¤ bug
- `æ–‡æ¡£`: æ–‡æ¡£ç›¸å…³
- `æ ·å¼`: ä»£ç æ ¼å¼åŒ–ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰
- `é‡æ„`: é‡æ„ä»£ç 
- `æµ‹è¯•`: æ·»åŠ æˆ–ä¿®æ”¹æµ‹è¯•
- `æ„å»º`: æ„å»ºç³»ç»Ÿæˆ–ä¾èµ–ç›¸å…³
- `CI`: CI é…ç½®ç›¸å…³

### ç¤ºä¾‹

```
åŠŸèƒ½: æ·»åŠ é‡è¯•æœºåˆ¶

å®ç°äº†åŸºäºæŒ‡æ•°é€€é¿çš„é‡è¯•ç®—æ³•ï¼Œæ”¯æŒï¼š
- æœ€å¤§é‡è¯•æ¬¡æ•°é…ç½®
- åˆå§‹å»¶è¿Ÿè®¾ç½®
- æœ€å¤§å»¶è¿Ÿé™åˆ¶

Closes #1
```

## ğŸ” ä»£ç è´¨é‡

### æ£€æŸ¥æ¸…å•

- [ ] ä»£ç é€šè¿‡ `go test ./...`
- [ ] ä»£ç é€šè¿‡ `go fmt ./...`
- [ ] ä»£ç é€šè¿‡ `golangci-lint run`
- [ ] æ·»åŠ å¿…è¦çš„æµ‹è¯•ç”¨ä¾‹
- [ ] æœ¬åœ° act æµ‹è¯•é€šè¿‡
- [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£

### æœ¬åœ°è´¨é‡æ£€æŸ¥

```bash
# æ ¼å¼æ£€æŸ¥
gofmt -s -l .

# é™æ€åˆ†æ
golangci-lint run

# å®‰å…¨æ‰«æ
gosec ./...

# æµ‹è¯•è¦†ç›–ç‡
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

## ğŸ“¦ é¡¹ç›®è¯´æ˜

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ª Go åº“é¡¹ç›® (`go-slim.dev/infra`)ï¼Œæä¾›ï¼š

- **backoff**: æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶
- **co**: å¹¶å‘å·¥å…·åŒ…
- **sdm**: ç®€å•çš„åˆ†å¸ƒå¼äº’æ–¥é”å®ç°

**ç‰¹ç‚¹**ï¼š

- âœ… æ— ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶
- âœ… ä½œä¸º Go åŒ…è¢«å…¶ä»–é¡¹ç›®å¯¼å…¥
- âœ… é€šè¿‡ `go get` å®‰è£…ä½¿ç”¨
- âŒ ä¸éœ€è¦äºŒè¿›åˆ¶å‘å¸ƒ
- âŒ ä¸éœ€è¦ Docker å®¹å™¨åŒ–

## ğŸ› ï¸ å¼€å‘é…ç½®

### ä¿®æ”¹ Go ç‰ˆæœ¬

åœ¨ `.github/workflows/ci.yml` ä¸­ä¿®æ”¹ï¼š

```yaml
env:
  GO_VERSION: "1.25" # ä¿®æ”¹ä¸ºéœ€è¦çš„ç‰ˆæœ¬
```

### æ·»åŠ æ–°çš„æµ‹è¯•å¹³å°

åœ¨ matrix ç­–ç•¥ä¸­æ·»åŠ ï¼š

```yaml
strategy:
  matrix:
    include:
      - goos: freebsd
        goarch: amd64
```

## ğŸ› æ•…éšœæ’é™¤

### Act å¸¸è§é—®é¢˜

#### 1. M1 èŠ¯ç‰‡è­¦å‘Š

å¦‚æœé‡åˆ° M1 èŠ¯ç‰‡ç›¸å…³è­¦å‘Šï¼Œç¡®ä¿ `.actrc` ä¸­åŒ…å«ï¼š

```
--container-architecture linux/amd64
```

#### 2. é•œåƒæ‹‰å–é—®é¢˜

å¦‚æœé‡åˆ°é•œåƒæ‹‰å–é—®é¢˜ï¼Œå¯ä»¥ï¼š

- ä½¿ç”¨ `.actrc` ä¸­å¤‡é€‰çš„é•œåƒæºé…ç½®
- é…ç½® Docker Desktop é•œåƒåŠ é€Ÿå™¨
- ä½¿ç”¨ä»£ç†

#### 3. æƒé™é—®é¢˜

ç¡®ä¿ `act` å’Œ Docker æœ‰é€‚å½“æƒé™ï¼š

```bash
sudo usermod -aG docker $USER
# é‡å¯ Docker Desktop
```

#### 4. è®¤è¯é—®é¢˜

é»˜è®¤ä½¿ç”¨ fake tokenï¼Œå¦‚éœ€çœŸå® GitHub Tokenï¼š

```bash
# ç¼–è¾‘ .secrets æ–‡ä»¶
# æ³¨é‡Šæ‰ fake tokenï¼Œå–æ¶ˆæ³¨é‡Šå¹¶å¡«å…¥çœŸå® token
```

#### 5. å¸¸ç”¨è°ƒè¯•å‘½ä»¤

```bash
# æ¸…ç† act ç¼“å­˜
act --clean

# ä½¿ç”¨è¯¦ç»†æ—¥å¿—
act --verbose

# æŸ¥çœ‹å¯ç”¨å·¥ä½œæµ
act -l

# è¿è¡Œç‰¹å®š job
act -j test

# æŒ‡å®šå·¥ä½œæµæ–‡ä»¶
act -W .github/workflows/ci.yml
```

### ç½‘ç»œé—®é¢˜

å¦‚æœåœ¨ä¸­å›½å¤§é™†è¿è¡Œï¼Œå¯èƒ½éœ€è¦é…ç½®ä»£ç†ï¼š

```bash
export HTTP_PROXY=http://127.0.0.1:7890
export HTTPS_PROXY=http://127.0.0.1:7890
```

## ğŸ¤ è´¡çŒ®æµç¨‹

1. **Fork** æœ¬ä»“åº“
2. **åˆ›å»º** ç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/amazing-feature`)
3. **æœ¬åœ°æµ‹è¯•**: è¿è¡Œ `act` ç¡®ä¿æµ‹è¯•é€šè¿‡
4. **æäº¤** æ›´æ”¹ (`git commit -m "åŠŸèƒ½: æ·»åŠ æ–°åŠŸèƒ½"`)
5. **æ¨é€** åˆ°åˆ†æ”¯ (`git push origin feature/amazing-feature`)
6. **åˆ›å»º** Pull Request

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [GitHub Actions å®˜æ–¹æ–‡æ¡£](https://docs.github.com/en/actions)
- [Act æœ¬åœ°è¿è¡Œå™¨](https://github.com/nektos/act)
- [Go å®˜æ–¹æ–‡æ¡£](https://golang.org/doc/)
- [Go è´¡çŒ®æŒ‡å—](https://github.com/golang/go/blob/master/CONTRIBUTING.md)

## ğŸ“„ è®¸å¯è¯

è¯·ç¡®ä¿æ‚¨çš„è´¡çŒ®ç¬¦åˆé¡¹ç›®çš„è®¸å¯è¯è¦æ±‚ã€‚
